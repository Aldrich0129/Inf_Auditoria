# ==============================================================================
# PLATAFORMA DE GENERACI√ìN DE INFORMES - ESTRUCTURA DEL PROYECTO
# ==============================================================================

## Estructura de Carpetas y Archivos

```
project_root/
‚îÇ
‚îú‚îÄ‚îÄ README.md                          # Documentaci√≥n principal del proyecto
‚îú‚îÄ‚îÄ requirements.txt                   # Dependencias Python
‚îÇ
‚îî‚îÄ‚îÄ report_platform/                   # Paquete principal
    ‚îÇ
    ‚îú‚îÄ‚îÄ __init__.py                    # Exporta componentes principales
    ‚îÇ
    ‚îú‚îÄ‚îÄ core/                          # üî∑ N√öCLEO GEN√âRICO (independiente del dominio)
    ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ   ‚îú‚îÄ‚îÄ config_loader.py           # Carga manifests y archivos YAML
    ‚îÇ   ‚îú‚îÄ‚îÄ schema_models.py           # Modelos Pydantic (SimpleField, BlockDefinition, etc.)
    ‚îÇ   ‚îú‚îÄ‚îÄ conditions_engine.py       # Motor de evaluaci√≥n de condiciones
    ‚îÇ   ‚îú‚îÄ‚îÄ word_engine.py             # Renderizado de documentos Word
    ‚îÇ   ‚îú‚îÄ‚îÄ tables_engine.py           # Validaci√≥n de estructuras de tabla
    ‚îÇ   ‚îú‚îÄ‚îÄ ui_runtime.py              # Generaci√≥n din√°mica de controles UI
    ‚îÇ   ‚îî‚îÄ‚îÄ utils.py                   # Utilidades (logging, paths)
    ‚îÇ
    ‚îú‚îÄ‚îÄ reports/                       # üî∑ PLUGINS DE INFORMES
    ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ informe_auditoria/         # Plugin: Informe de Auditor√≠a
    ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ       ‚îú‚îÄ‚îÄ manifest.yaml          # Metadatos del plugin
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îú‚îÄ‚îÄ templates/             # Plantillas Word
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ plantilla_informe.txt
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îú‚îÄ‚îÄ config/                # Configuraci√≥n YAML
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ variables_simples.yaml
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ variables_condicionales.yaml
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ bloques_texto.yaml
    ‚îÇ       ‚îÇ
    ‚îÇ       ‚îî‚îÄ‚îÄ logic.py               # L√≥gica espec√≠fica (build_context)
    ‚îÇ
    ‚îî‚îÄ‚îÄ ui/                            # üî∑ INTERFAZ WEB UNIFICADA
        ‚îú‚îÄ‚îÄ __init__.py
        ‚îú‚îÄ‚îÄ router.py                  # Descubrimiento y carga de plugins
        ‚îî‚îÄ‚îÄ app.py                     # Aplicaci√≥n Streamlit principal
```

## Descripci√≥n de los M√≥dulos

### üì¶ Core (N√∫cleo)

**Responsabilidad:** Proporcionar funcionalidad gen√©rica reutilizable

1. **config_loader.py**
   - Carga y valida archivos YAML (manifests, campos, bloques)
   - Parsea definiciones de plugins
   - Funciones: load_manifest(), load_yaml_config(), load_plugin_config()

2. **schema_models.py**
   - Modelos Pydantic para validaci√≥n de datos
   - Clases: SimpleField, ConditionalVariable, BlockDefinition, TableDefinition, Manifest
   - Asegura integridad de la configuraci√≥n

3. **conditions_engine.py**
   - Eval√∫a expresiones condicionales de forma segura
   - Funciones: evaluate_condition(), evaluate_block(), evaluate_all_blocks()
   - Soporta operadores: ==, !=, and, or, not, in

4. **word_engine.py**
   - Motor de renderizado de documentos Word
   - Actualmente: Implementaci√≥n placeholder (genera .txt)
   - Futuro: Integraci√≥n con python-docx-template o docxtpl
   - Funci√≥n principal: render_word_report()

5. **tables_engine.py**
   - Validaci√≥n de datos tabulares
   - Funciones: validate_table_data(), filter_table_rows(), aggregate_table_column()
   - Conversi√≥n entre formatos (dict_list ‚Üî table)

6. **ui_runtime.py**
   - Genera controles Streamlit din√°micamente desde YAML
   - Funciones: render_field(), render_all_fields(), validate_form_data()
   - Soporta: text, number, lista, text_area, campos calculados

7. **utils.py**
   - Utilidades auxiliares
   - Logging configurado
   - Manejo de paths y archivos

### üì¶ Reports (Plugins)

**Responsabilidad:** Contener la l√≥gica espec√≠fica de cada tipo de informe

Estructura de un plugin:
```
plugin_name/
‚îú‚îÄ‚îÄ manifest.yaml          # ID, nombre, versi√≥n, paths
‚îú‚îÄ‚îÄ templates/            # Plantilla(s) Word con {{ variables }}
‚îÇ   ‚îî‚îÄ‚îÄ plantilla.docx
‚îú‚îÄ‚îÄ config/               # YAMLs de configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ variables_simples.yaml
‚îÇ   ‚îú‚îÄ‚îÄ variables_condicionales.yaml
‚îÇ   ‚îî‚îÄ‚îÄ bloques_texto.yaml
‚îî‚îÄ‚îÄ logic.py              # Funci√≥n build_context(data_in) -> context
```

**Plugin incluido: informe_auditoria**
- 70+ campos configurables
- Variables condicionales para tipo de opini√≥n, cuentas, entidad
- Bloques de texto adaptativos seg√∫n normativa
- Soporta: EIP, KAM/AMRA, incertidumbres, √©nfasis

### üì¶ UI (Interfaz)

**Responsabilidad:** Proporcionar interfaz web unificada y din√°mica

1. **router.py**
   - Descubre plugins autom√°ticamente en reports/
   - Carga configuraci√≥n completa de plugins
   - Importa din√°micamente el m√≥dulo logic.py
   - Funciones: list_available_reports(), load_report_plugin()

2. **app.py**
   - Aplicaci√≥n Streamlit principal
   - Renderiza formularios din√°micos bas√°ndose en YAML
   - Flujo:
     1. Seleccionar plugin
     2. Cargar configuraci√≥n
     3. Renderizar variables condicionales
     4. Renderizar campos simples (organizados por secciones)
     5. Validar datos
     6. Generar informe con build_context()
     7. Ofrecer descarga

## Flujo de Datos

```
Usuario
  ‚Üì
[Streamlit UI] (app.py)
  ‚Üì
Selecciona plugin ‚Üí [Router] (router.py)
  ‚Üì
Carga config ‚Üí [Config Loader] (config_loader.py)
  ‚Üì
Renderiza UI ‚Üí [UI Runtime] (ui_runtime.py)
  ‚Üì
Usuario completa formulario
  ‚Üì
Validar datos ‚Üí [Schema Models] (schema_models.py)
  ‚Üì
build_context() ‚Üí [Plugin Logic] (logic.py)
  ‚îú‚Üí Eval√∫a condiciones ‚Üí [Conditions Engine] (conditions_engine.py)
  ‚îî‚Üí Renderiza bloques ‚Üí [Jinja2]
  ‚Üì
Contexto completo
  ‚Üì
Renderiza Word ‚Üí [Word Engine] (word_engine.py)
  ‚Üì
Documento generado ‚Üí [Outputs]
```

## Caracter√≠sticas Clave

### ‚úÖ Arquitectura Modular
- Core completamente gen√©rico
- Plugins autocontenidos
- F√°cil agregar nuevos tipos de informe

### ‚úÖ Configuraci√≥n Declarativa
- Todo definido en YAML
- Sin c√≥digo hardcodeado en core/UI
- Cambios en YAML ‚Üí Cambios inmediatos en UI

### ‚úÖ UI Din√°mica
- Formularios generados autom√°ticamente
- Campos condicionales (dependencias)
- Validaci√≥n autom√°tica
- Agrupaci√≥n por secciones

### ‚úÖ Motor de Condiciones
- Evaluaci√≥n segura de expresiones
- Soporta l√≥gica compleja (AND, OR, NOT)
- Usado para:
  - Mostrar/ocultar campos
  - Seleccionar bloques de texto
  - Calcular variables derivadas

### ‚úÖ Extensibilidad
- Agregar plugin = crear carpeta + 4 archivos
- No modificar core/UI
- Detecci√≥n autom√°tica de nuevos plugins

## C√≥mo Agregar un Nuevo Plugin

1. **Crear estructura de carpeta:**
   ```
   reports/mi_nuevo_informe/
   ‚îú‚îÄ‚îÄ manifest.yaml
   ‚îú‚îÄ‚îÄ templates/plantilla.docx
   ‚îú‚îÄ‚îÄ config/
   ‚îÇ   ‚îú‚îÄ‚îÄ variables_simples.yaml
   ‚îÇ   ‚îî‚îÄ‚îÄ bloques_texto.yaml
   ‚îî‚îÄ‚îÄ logic.py
   ```

2. **Definir manifest.yaml:**
   ```yaml
   id: mi_nuevo_informe
   nombre: Mi Nuevo Informe
   version: "1.0"
   paths:
     template: templates/plantilla.docx
     config_dir: config
   ```

3. **Crear plantilla Word:**
   - Usar variables {{ variable_name }}
   - Sin l√≥gica Jinja2 (if/for)

4. **Definir campos en YAML:**
   - variables_simples.yaml
   - variables_condicionales.yaml (opcional)
   - bloques_texto.yaml (opcional)

5. **Implementar logic.py:**
   ```python
   def build_context(data_in: Dict[str, Any], 
                     config_dir: Path = None) -> Dict[str, Any]:
       # Tu l√≥gica aqu√≠
       return context
   ```

6. **Ejecutar app:**
   ```bash
   streamlit run report_platform/ui/app.py
   ```
   
   ¬°El nuevo plugin aparecer√° autom√°ticamente en el selector!

## Convenciones de C√≥digo

- **Idioma:** Comentarios y docstrings en espa√±ol
- **Type hints:** Obligatorio en todas las funciones
- **Logging:** Usar logger de utils.setup_logger()
- **Imports:** Rutas absolutas (from report_platform.core...)
- **Naming:**
  - Archivos: snake_case
  - Clases: PascalCase
  - Funciones: snake_case
  - Constantes: UPPER_SNAKE_CASE

## Pr√≥ximas Mejoras Sugeridas

1. **Word Engine completo:**
   - Integrar python-docx-template o docxtpl
   - Preservar formato de plantillas

2. **Soporte para tablas din√°micas:**
   - UI para agregar/eliminar filas
   - Validaci√≥n de datos tabulares

3. **Exportaci√≥n m√∫ltiple:**
   - PDF
   - HTML
   - Markdown

4. **Validaciones avanzadas:**
   - Reglas de validaci√≥n personalizadas
   - Validaci√≥n cruzada entre campos

5. **Tests:**
   - Unit tests para core
   - Integration tests para plugins

6. **Cache:**
   - Cache de configuraciones cargadas
   - Mejora de performance

## Contacto y Soporte

**Autor:** Jimmy  
**Organizaci√≥n:** Forvis Mazars Espa√±a  
**Versi√≥n:** 1.0.0  
**Fecha:** Diciembre 2024

---

Para cualquier duda o sugerencia, consultar la documentaci√≥n completa en README.md
