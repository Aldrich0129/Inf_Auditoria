# DOCUMENTACIÓN - SISTEMA DE GENERACIÓN DE INFORMES DE AUDITORÍA

## Archivos generados:

1. **variables_simples.yaml** - Define todas las variables que el usuario debe completar
2. **variables_condicionales.yaml** - Define todas las condiciones que afectan al texto del informe
3. **plantilla_word.txt** - Plantilla lista para importar en Word con todos los marcadores

---

## 1. VARIABLES_SIMPLES.YAML

### Estructura:
Contiene **66 variables** organizadas en 6 categorías principales:

#### a) Variables tipo LISTA (Dropdown):
- `destinatarios_informe` (4 opciones)
- `destinatarios_accionistas` (8 opciones)
- `tipo_junta_nombramiento` (3 opciones)

#### b) Variables tipo TEXTO:
- Información de la entidad: nombre_entidad, entidad_encargante
- Información del auditor: ciudad_auditoria, firma_auditor, nombre_auditor

#### c) Variables tipo NÚMERO:
- Números ROAC
- Referencias a notas de la memoria
- Períodos de auditoría

#### d) Variables tipo FECHA (Agrupadas):
Se agruparon las fechas que siempre aparecen juntas:
- fecha_cierre_ejercicio (día/mes/año)
- fecha_informe_auditoria (día/mes/año)
- fecha_informe_adicional (día/mes/año)
- fecha_nombramiento (día/mes/año)
- fecha_inicio_periodo (día/mes/año)
- fecha_inicio_auditoria_anterior (día/mes/año)
- fecha_informe_auditoria_ejercicioanterior (día/mes/año)

#### e) Variables LOCALES (específicas de condiciones):
Estas variables solo aparecen cuando se cumplen ciertas condiciones:
- `numero_nota_incorreccion` (solo si tipo_opinion=="salvedades" AND motivo_calificacion=="incorreccion")
- `numero_nota_limitacion` (solo si tipo_opinion=="salvedades" AND motivo_calificacion=="limitacion")
- `numero_nota_desfavorable` (solo si tipo_opinion=="desfavorable")
- `numero_nota_denegada` (solo si tipo_opinion=="denegada")
- Variables de incertidumbre funcionamiento
- Variables de eventos específicos

#### f) Variables tipo TEXTO LARGO (Descriptivas):
Para contenidos que requieren explicación detallada:
- `descripcion_incorreccion`
- `descripcion_limitacion`
- `descripcion_desfavorable`
- `descripcion_kam_amra`
- `procedimientos_auditoria_kam`
- `descripcion_enfasis`
- `descripcion_servicios_adicionales`

### Campos importantes de cada variable:
- `id`: Identificador único
- `nombre`: Nombre descriptivo para la UI
- `tipo`: lista, texto, numero, fecha, texto_largo
- `requerido`: true/false
- `seccion`: Agrupación en la interfaz
- `dependencia`: Indica cuándo mostrar la variable
- `ambito`: "local" o "global" (por defecto global)
- `condicion_padre`: Para variables locales, indica la condición que las activa

---

## 2. VARIABLES_CONDICIONALES.YAML

### Estructura:
Contiene **18 variables condicionales** que determinan qué texto se incluye en el informe.

### Condiciones principales:

1. **tipo_cuentas**: consolidadas / abreviadas / normales
2. **tipo_auditoria**: Obligatoria / Voluntaria
3. **tipo_entidad**: EIP / No EIP
4. **tipo_opinion**: favorable / salvedades / desfavorable / denegada
5. **marco_normativo**: NIIF-UE / PGC
6. **limitacion_alcance**: si / no
7. **motivo_calificacion**: incorreccion / limitacion
8. **incertidumbre_funcionamiento**: si / no
9. **enfasis_adicional**: si / no
10. **amra_voluntario**: si / no
11. **otros_kam**: si / no
12. **otros_amra**: si / no
13. **otras_cuestiones**: si / no
14. **texto_cuestiones**: informe otro auditor / cuentas anuales no auditadas / otros
15. **obligacion_presentar_informe_gestion**: si / no
16. **obligacion_EINF**: si / no
17. **einf_facilitado**: si / no
18. **entidad_cotizada**: si / no
19. **incluir_PAR_section**: si / no
20. **auditor_continuidad**: si / no

### Características de cada condición:
- `id`: Identificador único
- `nombre`: Nombre descriptivo
- `descripcion`: Explicación de qué controla
- `tipo_control`: radio, checkbox, select
- `opciones`: Array de valores posibles con:
  - `valor`: Valor interno
  - `etiqueta`: Texto para mostrar
  - `descripcion`: Ayuda adicional
  - `variables_asociadas`: Variables simples que se activan con esta opción
  - `es_default`: Indica el valor por defecto

### Combinaciones especiales:
El archivo incluye una sección de "combinaciones_especiales" que documenta las interacciones complejas entre condiciones múltiples.

### Configuración del motor:
- Motor: Jinja2
- Sintaxis de marcadores:
  - Inicio: `{{si`
  - Fin: `{{fin si}}`
  - Else: `{{else}}`
  - Operadores: `==`, `!=`, `and`, `or`

---

## 3. PLANTILLA_WORD.TXT

### Descripción:
Plantilla lista para importar en Microsoft Word con todos los marcadores correctamente formateados.

### Características:
- **Codificación**: UTF-8
- **Formato**: Texto plano con marcadores
- **Total de líneas**: ~350 líneas

### Sintaxis de marcadores:

#### Variables simples:
```
{{nombre_variable}}
```

#### Condiciones:
```
{{si condicion=="valor"}}
  Texto a incluir si se cumple
{{fin si}}
```

#### Condiciones con alternativa:
```
{{si condicion=="valor"}}
  Texto para valor verdadero
{{else}}
  Texto para valor falso
{{fin si}}
```

#### Condiciones múltiples:
```
{{si condicion1=="valor1" and condicion2=="valor2"}}
  Texto que requiere ambas condiciones
{{fin si}}
```

### Importación a Word:
1. Abrir Word
2. Crear nuevo documento
3. Aplicar estilos y formato deseado
4. Importar/pegar el contenido del TXT
5. Los marcadores `{{variable}}` y `{{si...}}` quedarán listos para ser procesados por tu aplicación

---

## FLUJO DE TRABAJO RECOMENDADO

### En la aplicación Python:

1. **Carga de configuración**:
   ```python
   import yaml
   
   with open('variables_simples.yaml', 'r', encoding='utf-8') as f:
       variables_simples = yaml.safe_load(f)
   
   with open('variables_condicionales.yaml', 'r', encoding='utf-8') as f:
       variables_condicionales = yaml.safe_load(f)
   ```

2. **Generación de UI**:
   - Usar `variables_simples` para generar formularios
   - Agrupar por `seccion`
   - Aplicar validaciones según `tipo` y `requerido`
   - Mostrar/ocultar campos según `dependencia`

3. **Procesamiento de condiciones**:
   - Usar `variables_condicionales` para determinar qué bloques de texto incluir
   - Evaluar expresiones usando Jinja2 o lógica personalizada
   - Sustituir variables simples en el texto resultante

4. **Generación del documento**:
   - Cargar plantilla de Word
   - Procesar condiciones (evaluar `{{si...}}`)
   - Sustituir variables simples (`{{variable}}`)
   - Aplicar formato final
   - Exportar documento

---

## NOTAS IMPORTANTES

### Variables locales vs globales:
- **Globales**: Aparecen en múltiples lugares del documento
- **Locales**: Solo aparecen dentro de un bloque condicional específico
  - La UI solo debe mostrarlas cuando se cumple su `condicion_padre`
  - Su valor solo se usa en contextos específicos

### Validaciones recomendadas:
1. Fechas coherentes (informe posterior a cierre)
2. Campos requeridos completos
3. Consistencia entre variables condicionales relacionadas
4. Números de nota únicos y válidos

### Extensibilidad:
- Para añadir nuevas variables: agregar en `variables_simples.yaml`
- Para nuevas condiciones: agregar en `variables_condicionales.yaml`
- Para nuevas secciones de texto: actualizar `plantilla_word.txt`

---

## ESTADÍSTICAS

### Variables simples:
- Total: 66 variables
- Tipo lista: 3
- Tipo texto: 6
- Tipo número: 7
- Tipo fecha: 7 (agrupadas de 21 componentes)
- Tipo texto largo: 7
- Locales: 14
- Globales: 52

### Variables condicionales:
- Total: 20 condiciones
- Con dependencias: 8
- Binarias (si/no): 13
- Multi-opción: 7

### Plantilla:
- Bloques condicionales: ~45
- Marcadores de variables: ~150
- Condiciones anidadas: Hasta 3 niveles

---

Fecha de generación: Noviembre 2024
Versión: 1.0
